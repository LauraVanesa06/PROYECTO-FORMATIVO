<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Appsena" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="csrf-token" content="<%= form_authenticity_token %>">

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag :abootstrap, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag :application, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "login_sidebar_optimized", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "dynamic_nav", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="<%= asset_path 'dynamic_nav.js' %>"></script>
    <script src="<%= asset_path 'favorites_offcanvas.js' %>"></script>
    <script src="<%= asset_path 'favorites_management.js' %>"></script>
    
  </head>

  <body>
    <main>
      <!-- HEADER -->
      <header class="container-header"> 
        <nav class="main-nav d-flex gap-3">
          <%= link_to t("nav.home"), authenticated_root_path, id:"nav-home", class: "text-white fw-bold nav-home" %>
          <%= link_to t("nav.products"), productos_path, class: "text-white fw-bold nav-products" %>
          <%= link_to t("nav.contacts"), contactos_path, class: "text-white fw-bold nav-contacts" %>
        </nav>

        <!-- Iconos -->
        <div class="header-icons d-flex align-items-center gap-3 text-white fs-5">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
              üåê <%= I18n.locale.upcase %>
            </button>
            <ul class="dropdown-menu">
              <li><%= link_to t("languages.spanish"), url_for(locale: :es), class: "dropdown-item" %></li>
              <li><%= link_to t("languages.english"), url_for(locale: :en), class: "dropdown-item" %></li>
            </ul>
          </div>

          <% if user_signed_in? %>
            <%= link_to "#",
                        class: "text-white1 position-relative",
                        data: { bs_toggle: "offcanvas", bs_target: "#favoritesOffcanvas" } do %>
              <i class="fa-solid fa-star"></i>
              <% favorites_count = current_user&.favorites&.count || 0 %>
              <% if favorites_count > 0 %>
                <span id="favorites-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  <%= favorites_count %>
                  <span class="visually-hidden">productos favoritos</span>
                </span>
              <% else %>
                <span id="favorites-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                  0
                  <span class="visually-hidden">productos favoritos</span>
                </span>
              <% end %>
            <% end %>
          <% else %>
            <button id="layoutFavoritesBtn" class="btn btn-link text-white1 p-0">
              <i class="fa-solid fa-star"></i>
            </button>
          <% end %>

          <% unless current_page?(cart_path) %>
            <%= link_to "#",
                        class: "text-white1 position-relative",
                        data: { bs_toggle: "offcanvas", bs_target: "#cartOffcanvas" } do %>
              <i class="fa-solid fa-cart-shopping"></i>
              <% cart_count = @cart&.cart_items&.sum(:cantidad) || 0 %>
              <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="<%= 'display: none;' if cart_count == 0 %>">
                <%= cart_count %>
                <span class="visually-hidden">productos en carrito</span>
              </span>
            <% end %>
          <% end %>

          <!-- Bot√≥n de usuario que abre el sidebar -->
          <button id="userButton" class="btn btn-outline-light border-0" aria-label="Perfil">
            <i class="fa-solid fa-user"></i>
          </button>
        </div>
      </header>

      <!-- CONTENIDO PRINCIPAL -->
      <div id="dynamic-content">
        <%= yield %>
      </div>

      <!-- FOOTER -->
      <footer id="footer" class="bg-dark text-white text-center p-3 mt-auto">
        &copy; 2025 <%= t("app.name") %> - v3.8.5
      </footer>
    </main>

    <%= javascript_include_tag 'application2', "data-turbo-track": "reload" %>
    <%= javascript_include_tag 'mi_script', "data-turbo-track": "reload" %>

    <!-- Offcanvas del carrito -->
    <% unless current_page?(cart_path) %>
      <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header" style="position: relative; padding-bottom: 0;">
          <div class="section-header" style="width: 100%;">
            <h2 class="titulo"><%= t("cart.title") %></h2>
            <center><hr class="linea-bonita"></center>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body" id="cart-offcanvas-body">
          <%= render partial: "carts/cart_items", locals: { cart_items: @cart&.cart_items || [] } %>
        </div>
      </div>
    <% end %>

    <!-- Offcanvas de favoritos -->
    <% if user_signed_in? %>
      <div class="offcanvas offcanvas-end" tabindex="-1" id="favoritesOffcanvas">
        <div class="offcanvas-header" style="position: relative; padding-bottom: 0;">
          <div class="section-header" style="width: 100%;">
            <h2 class="titulo"><i class="fa-solid fa-heart"></i> <%= t("favorites.title") %></h2>
            <center><hr class="linea-bonita"></center>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body" id="favorites-offcanvas-body">
          <%= render partial: "favorites/favorites_list", locals: { favorites: current_user&.favorites || [] } %>
        </div>
      </div>
    <% end %>

    <!-- üß© Sidebar del perfil (logueado o no) -->
    <div id="profileSidebar" class="profile-sidebar shadow-lg">
      <% if user_signed_in? %>
        <%= render 'shared/user_profile_sidebar' %>
      <% else %>
        <div class="profile-sidebar-header d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0 profile-title">Mi Perfil</h5>
          <button id="closeSidebar" class="btn-close-profile">‚úï</button>
        </div>

        <div class="text-center mb-4">
          <div class="profile-user-icon mx-auto mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="white" viewBox="0 0 16 16">
              <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
            </svg>
          </div>
        </div>

        <div class="profile-sidebar-body">
          <div class="text-center">
            <p class="profile-info-text">Inicia sesi√≥n para acceder a tu perfil.</p>
            <%= link_to "Ir al login", new_user_session_path, class: "btn btn-primary w-100 login-btn-submit" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Fondo borroso -->

    <% if flash[:notice] %>
      <div class="alert alert-success"><%= flash[:notice] %></div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert alert-danger"><%= flash[:alert] %></div>
    <% end %>
    <script>
      console.log("CSRF:", document.querySelector('meta[name=csrf-token]').content);
      
      // Convertir alertas en notificaciones toast arriba
      document.addEventListener("DOMContentLoaded", function() {
        const alerts = document.querySelectorAll(".alert:not(.offcanvas-body .alert)");
        
        alerts.forEach(alert => {
          // Obtener el mensaje y tipo de alerta
          const message = alert.textContent.trim();
          const isSuccess = alert.classList.contains("alert-success");
          const type = isSuccess ? "success" : "danger";
          
          // Crear el contenedor de notificaci√≥n
          const notification = document.createElement("div");
          notification.className = `notification notification-${type}`;
          notification.innerHTML = `
            <div class="notification-content">
              <span class="notification-message">${message}</span>
              <button class="notification-close">&times;</button>
            </div>
          `;
          
          // Agregar estilos
          const style = document.createElement("style");
          style.textContent = `
            .notification {
              position: fixed;
              top: 20px;
              right: 20px;
              max-width: 400px;
              padding: 16px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
              z-index: 9999;
              animation: slideIn 0.3s ease;
              font-family: 'Poppins', sans-serif;
            }
            
            .notification-success {
              background-color: #d4edda;
              color: #155724;
              border: 1px solid #c3e6cb;
            }
            
            .notification-danger {
              background-color: #f8d7da;
              color: #721c24;
              border: 1px solid #f5c6cb;
            }
            
            .notification-content {
              display: flex;
              justify-content: space-between;
              align-items: center;
              gap: 15px;
            }
            
            .notification-message {
              flex: 1;
            }
            
            .notification-close {
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              padding: 0;
              color: inherit;
              opacity: 0.7;
              transition: opacity 0.2s;
            }
            
            .notification-close:hover {
              opacity: 1;
            }
            
            @keyframes slideIn {
              from {
                transform: translateX(400px);
                opacity: 0;
              }
              to {
                transform: translateX(0);
                opacity: 1;
              }
            }
            
            @keyframes slideOut {
              from {
                transform: translateX(0);
                opacity: 1;
              }
              to {
                transform: translateX(400px);
                opacity: 0;
              }
            }
            
            @media (max-width: 768px) {
              .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
              }
            }
          `;
          
          if (!document.querySelector("style[data-notifications]")) {
            style.setAttribute("data-notifications", "true");
            document.head.appendChild(style);
          }
          
          // Agregar la notificaci√≥n al body
          document.body.appendChild(notification);
          
          // Ocultar la alerta original
          alert.style.display = "none";
          
          // Funci√≥n para remover la notificaci√≥n
          const removeNotification = () => {
            notification.style.animation = "slideOut 0.3s ease";
            setTimeout(() => {
              notification.remove();
            }, 300);
          };
          
          // Bot√≥n de cerrar
          notification.querySelector(".notification-close").addEventListener("click", removeNotification);
          
          // Auto-remover despu√©s de 4 segundos
          setTimeout(removeNotification, 4000);
        });
      });
    </script>

    <div id="deviseSidebarContainer"></div>

    <script>
      // Indica al frontend si hay sesi√≥n activa
      window.isLoggedIn = <%= user_signed_in? %>;

      // Bot√≥n de favorito en el layout para usuarios NO logueados
      document.addEventListener('DOMContentLoaded', function() {
        const layoutFavoritesBtn = document.getElementById('layoutFavoritesBtn');
        if (layoutFavoritesBtn) {
          layoutFavoritesBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Simplemente abre el sidebar de login
            openProfileSidebar();
          });
        }
      });
    </script>
  </body>
</html>
