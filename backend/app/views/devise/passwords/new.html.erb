<turbo-frame id="auth_frame">
  <div class="login-form-container">
    <!-- Icono de recuperación de contraseña -->
    <div class="text-center mb-4">
      <div class="recover-password-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="white" viewBox="0 0 16 16">
          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
          <path fill-rule="evenodd" d="M10.354 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
        </svg>
      </div>
    </div>

    <h3 class="text-center mb-3">Recuperar contraseña</h3>

    <p class="text-center mb-4 subtitle-text" id="instruction-text">
      Ingresa tu correo para recibir instrucciones
    </p>

    <%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :post, id: 'password-recovery-form' }) do |f| %>
      <div class="mb-4">
        <%= f.email_field :email, class: "form-control login-input-box", placeholder: "Correo electrónico", id: "recovery-email", autofocus: true, required: true, autocomplete: "off" %>
      </div>

      <div class="mb-4" id="code-field-container" style="display: none;">
        <%= text_field_tag 'user[recovery_code]', nil, class: "form-control login-input-box", placeholder: "Código de 6 dígitos", id: "recovery-code", maxlength: 6, pattern: "[0-9]{6}", inputmode: "numeric" %>
        <small class="text-muted d-block mt-2">Ingresa el código de 6 dígitos enviado a tu correo</small>
      </div>

      <div class="mb-4" id="password-fields-container" style="display: none;">
        <div class="mb-3">
          <%= password_field_tag 'user[password]', nil, class: "form-control login-input-box", placeholder: "Nueva contraseña", id: "new-password" %>
        </div>
        <div class="mb-3">
          <%= password_field_tag 'user[password_confirmation]', nil, class: "form-control login-input-box", placeholder: "Confirmar contraseña", id: "confirm-password" %>
        </div>
      </div>

      <div class="d-grid mb-3">
        <%= f.submit "Enviar instrucciones", class: "btn btn-primary w-100 login-btn-submit", id: "submit-btn" %>
      </div>
    <% end %>

    <div class="text-center mt-4">
      <%= link_to "Volver al inicio de sesión", new_user_session_path, class: "back-to-login-link" %>
    </div>
  </div>
</turbo-frame>

<script>
  let currentStep = 'email'; // email, code, password
  let userEmail = '';
  
  document.getElementById('password-recovery-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const submitBtn = document.getElementById('submit-btn');
    const instructionText = document.getElementById('instruction-text');
    const emailField = document.getElementById('recovery-email');
    const codeFieldContainer = document.getElementById('code-field-container');
    const codeField = document.getElementById('recovery-code');
    const passwordFieldsContainer = document.getElementById('password-fields-container');
    
    if (currentStep === 'email') {
      // Paso 1: Enviar email y obtener código
      userEmail = emailField.value;
      
      fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({ user: { email: userEmail } })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          // Mostrar campo de código
          currentStep = 'code';
          emailField.readOnly = true;
          emailField.style.backgroundColor = '#f0f0f0';
          codeFieldContainer.style.display = 'block';
          instructionText.textContent = 'Revisa tu correo y ingresa el código';
          submitBtn.value = 'Verificar código';
          codeField.focus();
          
          // Mostrar mensaje de éxito
          showMessage('Código enviado a tu correo. Revisa tu bandeja de entrada.', 'success');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('Error al enviar el código. Intenta nuevamente.', 'error');
      });
      
    } else if (currentStep === 'code') {
      // Paso 2: Verificar código
      const code = codeField.value;
      
      if (code.length !== 6) {
        showMessage('El código debe tener 6 dígitos', 'error');
        return;
      }
      
      // Mostrar campos de contraseña
      currentStep = 'password';
      codeField.readOnly = true;
      codeField.style.backgroundColor = '#f0f0f0';
      passwordFieldsContainer.style.display = 'block';
      instructionText.textContent = 'Ingresa tu nueva contraseña';
      submitBtn.value = 'Cambiar contraseña';
      
    } else if (currentStep === 'password') {
      // Paso 3: Cambiar contraseña
      const code = codeField.value;
      const password = document.getElementById('new-password').value;
      const passwordConfirmation = document.getElementById('confirm-password').value;
      
      fetch('/users/password', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          user: {
            email: userEmail,
            recovery_code: code,
            password: password,
            password_confirmation: passwordConfirmation
          }
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage('Contraseña cambiada exitosamente. Redirigiendo...', 'success');
          setTimeout(() => {
            window.location.href = '/users/sign_in';
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('Error al cambiar la contraseña', 'error');
      });
    }
  });
  
  function showMessage(text, type) {
    const existingAlert = document.querySelector('.temp-alert');
    if (existingAlert) existingAlert.remove();
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} temp-alert mt-3`;
    alert.textContent = text;
    
    document.getElementById('password-recovery-form').insertAdjacentElement('afterend', alert);
    
    setTimeout(() => alert.remove(), 5000);
  }
</script>
