<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Ferreter√≠a</title> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-radial-gauge@^0.3.0/dist/chartjs-chart-radial-gauge.min.js"></script>
  <%= favicon_link_tag 'favicon.png' %>
  <%= stylesheet_link_tag "dashboard", media: "all" %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Eczar:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">

  <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  <%= javascript_importmap_tags %>
</head>
<body>

  <header>
    <div class="container-header">
      <button class="hamburger" id="hamburger">&#9776;</button>
      <div id="control">
        <div class="panel"><%= image_tag "panel-control.png", class: "c-panel" %></div>
        <p class="pricipal">Panel de Control</p>
      </div>
      <% if user_signed_in? %>
        <%= link_to root_path, id: "cerrar", class: "logout2" do %>
          <span><i class="fas fa-arrow-left"></i></span>
        <% end %>
      <% end %>
    </div>
  </header>

  <nav class="nav-bg">
    <div class="container-nav">
      <ul class="menu" id="menu">
        <li><a href="#"class="link-menu">Inicio</a></li>
        <li><a href="/dashboard/productos"class="link-menu">Productos</a></li>
        <li><a href="/dashboard/ventas"class="link-menu">Ventas</a></li>
        <li><a href="/dashboard/pedidos"class="link-menu">Pedidos</a></li>
        <%# <li><a href="dashboard/suppliers"class="link-menu">Proveedores</a></li> %>
        <%# <li><a href="/dashboard/clientes"class="link-menu">Clientes</a></li> %>
        <li><a href="/dashboard/help"class="link-menu">Ayuda</a></li>
      </ul>
      <% if user_signed_in? %>
        <%= link_to "Ir a Inicio", root_path, id: "cerrar", class: "logout" %>
      <% end %>
    </div>
  </nav>

  <section class="fondo">
    <section class="section-1">
      <div class="grafica-1">
        <section class="graf-1">
          <canvas id="graficoClientesMes"></canvas>
        </section>
        <section class="texto-1">
          <div class="titulo-1">Registros de clientes nuevos</div>
          <div class="texto-1-1">Este dato permite visualizar la evoluci√≥n del negocio y el ritmo con el que se incrementa la cantidad
             de personas que acceden por primera vez a nuestros productos y servicios.</div>
        </section>
      </div>
      <div class="grafica-2">
        <section class="texto-2">
          <section class="texto-2-1"><div class="titulo-2">Ventas por categor√≠a de producto</div>Este gr√°fico presenta la distribuci√≥n de
            ventas por categor√≠as de productos, permitiendo identificar cu√°les generan mayores ingresos y aportan m√°s al rendimiento general del negocio.
          </section>
          <div class="img-2">
            <canvas id="gaugeSegmentado"></canvas>
            <div class="gauge-value">Stock<br>90%</div>
          </div>
        </section>
        <section class="graf-2">
          <canvas id="graficoVentas" ></canvas>
        </section>
      </div>
      <div class="grafica-3">
        <section>
          <div class="ingresos">
            <p class="flecha" id="F1">ü°Ö</p>
            <p class="etiqueta">Ingresos Totales</p>
            <p class="monto" id="ingresos">0$</p>
          </div>
        </section>
      </div>
    </section>

    <section class="section-2">
      <div class="grafica-4">
        <section class="graf-4-2">
          <div class="titulo-4-2">Ventas por M√©todo de Pago</div>
          <canvas id="graficoPago"></canvas>
        </section>
      </div>
      <div class="grafica-5">
        <section class="texto-5"><div class="titulo-5">Ventas por d√≠a / semana / mes</div>Esta secci√≥n muestra el total de ventas realizadas durante el periodo 
        seleccionado (diario, semanal o mensual). La informaci√≥n permite identificar tendencias, evaluar el rendimiento y apoyar la toma de decisiones estrat√©gicas.</section>

        <section class="graf-5">

          <!-- Dia -->
          <div class="grafico">
            <canvas id="grafDia" width="120" height="120"></canvas>
          </div>

          <!--Semana -->
          <div class="grafico">
            <canvas id="grafSemana" width="120" height="120"></canvas>
          </div>

          <!-- Mes -->
          <div class="grafico">
            <canvas id="grafMes" width="120" height="120"></canvas>
          </div>

        </section>

      </div>
    </section>
  </section>

  <footer>
    &copy; 2025 Ferremateriales el Maestro - v3.8.5
  </footer>

  <!-- grfaica de la seccion 1 -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/v1/clientes_por_mes')
      .then(res => res.json())
      .then(data => {
        const meses = [
          'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

        const valores = Object.values(data);
        const etiquetas = Object.keys(data).map(num => meses[parseInt(num) - 1]);

        // Filtrar solo los meses con valor > 0
        const valoresFiltrados = valores.filter(v => v > 0);
        const etiquetasFiltradas = etiquetas.filter((_, i) => valores[i] > 0);
        const colores = [
          '#1e88e5', '#103f91', '#1565c0', '#1976d2', '#2196f3',
          '#3399ff', '#42a5f5', '#1e88e5', '#64b5f6', '#90caf9',
          '#bbdefb', '#e3f2fd'
        ].slice(0, etiquetasFiltradas.length);

        const ctx = document.getElementById('graficoClientesMes').getContext('2d');

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: etiquetasFiltradas,
            datasets: [{
              data: valoresFiltrados,
              backgroundColor: colores,
              borderColor: '#bbbbbbff',
              borderWidth: 2,
              cutout: '40%'
            }]
          },
          options: {
            plugins: {
              legend: { display: false },
              datalabels: {
                color: 'white',
                font: {
                  weight: 'bold',
                  size: 14
                },
                formatter: (value, context) => {
                  const label = context.chart.data.labels[context.dataIndex];
                  return value > 0 ? `${label}: ${value}` : '';
                },
                display: (context) => context.dataset.data[context.dataIndex] > 0
              }
            }
          },
          plugins: [ChartDataLabels]
        });
      })
      .catch(error => console.error("Error cargando clientes por mes:", error));
  });
</script>





<!-- grafica 1 de la seccion 2 -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/v1/dashboard/porcentaje_stock')
      .then(res => res.json())
      .then(data => {
        const porcentaje = data.porcentaje;
        const totalSegmentos = 30;
        const segmentosActivos = Math.round((porcentaje / 100) * totalSegmentos);
        const datos = Array(totalSegmentos).fill(1);

        const azulClaro = [187, 222, 251]; 
        const azulOscuro = [13, 71, 161]; 

        const colores = Array.from({ length: totalSegmentos }, (_, i) => {
          if (i < segmentosActivos) {
            const t = i / (segmentosActivos - 1 || 1); 
            const r = Math.round(azulClaro[0] + (azulOscuro[0] - azulClaro[0]) * t);
            const g = Math.round(azulClaro[1] + (azulOscuro[1] - azulClaro[1]) * t);
            const b = Math.round(azulClaro[2] + (azulOscuro[2] - azulClaro[2]) * t);
            return `rgb(${r}, ${g}, ${b})`;
          } else {
            return '#616161';
          }
        });

        new Chart(document.getElementById('gaugeSegmentado'), {
          type: 'doughnut',
          data: {
            datasets: [{
              data: datos,
              backgroundColor: colores,
              borderColor: '#2b2d3fff',
              borderWidth: 1.5,
              hoverOffset: 0
            }]
          },
          options: {
            cutout: '65%',
            rotation: -90,
            circumference: 360,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            }
          }
        });

        const valorDiv = document.querySelector('.gauge-value');
        if (valorDiv) valorDiv.innerHTML = `Stock<br>${porcentaje}%`;
      })
      .catch(error => console.error("Error cargando porcentaje de stock:", error));
  });
</script>


<!-- grafica 2 de la seccion 2 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  fetch('/api/v1/ventas_por_categoria')
    .then(res => res.json())
    .then(data => {
      const ctx2 = document.getElementById('graficoVentas').getContext('2d');


      const azulClaro = [187, 222, 251];
      const azulOscuro = [13, 71, 161];

      const total = data.valores.length;
      const colores = Array.from({ length: total }, (_, i) => {
        const t = i / (total - 1 || 1);
        const r = Math.round(azulClaro[0] + (azulOscuro[0] - azulClaro[0]) * t);
        const g = Math.round(azulClaro[1] + (azulOscuro[1] - azulClaro[1]) * t);
        const b = Math.round(azulClaro[2] + (azulOscuro[2] - azulClaro[2]) * t);
        return `rgb(${r}, ${g}, ${b})`;
      });

      new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: data.etiquetas,
          datasets: [{
            label: 'Ventas (unidades)',
            data: data.valores,
            backgroundColor: colores,
            borderColor: colores,
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              align: 'start',
              anchor: 'end',
              color: 'white',
              formatter: (value, context) =>
                context.chart.data.labels[context.dataIndex] + ' (' + value + ')',
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: 'white' },
              title: {
                display: true,
                text: 'Unidades vendidas',
                color: 'white'
              },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
              ticks: { display: false },
              grid: { display: false }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    })
    .catch(err => console.error('Error al cargar ventas por categor√≠a:', err));
});
</script>


<!-- grafica de la seccion 3 -->

<script>
  function formatearPesos(valor) {
    return `$${valor.toLocaleString("es-CO")}`;
  }

  fetch('/api/v1/finanzas')
    .then(res => res.json())
    .then(data => {
      document.getElementById("ingresos").textContent = formatearPesos(data.ingresos);
      document.getElementById("egresos").textContent = formatearPesos(data.egresos);
    })
    .catch(err => console.error("Error al cargar datos financieros", err));
</script>

<!-- grafica 1 de la seccion 4 -->
<script>
  const canvas = document.getElementById('graficoPago');
  const ctx = canvas.getContext('2d');

  const scale = window.devicePixelRatio || 1;
  const visibleWidth = 500;
  const visibleHeight = 300;

  canvas.width = visibleWidth * scale;
  canvas.height = visibleHeight * scale;
  canvas.style.width = visibleWidth + 'px';
  canvas.style.height = visibleHeight + 'px';
  ctx.scale(scale, scale);

  fetch('/api/v1/ventas_por_metodo_pago')
    .then(res => res.json())
    .then(data => {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.etiquetas,
          datasets: [{
            data: data.valores,
            backgroundColor: [
              '#0d47a1',
              '#1976d2', 
              '#42a5f5',
              '#90caf9' 
            ],
            borderRadius: 5,
            borderSkipped: false
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            datalabels: {
              anchor: 'center',
              align: 'center',
              color: 'white',
              font: {
                family: 'Segoe UI',
                weight: 'bold',
                size: 30
              },
              formatter: function(value) {
                return value;
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#ffffff',
                font: {
                  size: 20
                }
              },
              grid: {
                color: '#666'
              }
            },
            x: {
              ticks: {
                color: '#ffffff',
                font: {
                  size: 20
                }
              },
              grid: {
                color: '#666'
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    })
    .catch(err => console.error('Error al cargar datos:', err));
</script>


<!-- grafica del seccion 5 -->
<script>
function crearDoughnut(id, cantidad, label) {
  const ctx = document.getElementById(id).getContext('2d');

  const centroTexto = {
    id: 'centroTexto',
    beforeDraw(chart) {
      const { width, height } = chart;
      const ctx = chart.ctx;
      ctx.restore();
      const fontSize = 16;
      ctx.font = `bold ${fontSize}px Poppins`;
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(label, width / 2, height / 2 - 10);
      ctx.fillText(cantidad, width / 2, height / 2 + 10);
      ctx.save();
    }
  };

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Dato', 'Restante'],
      datasets: [{
        data: [cantidad, 200 - cantidad],
        backgroundColor: ['#547AA5', '#1c2735'], // azul-gris elegante
        borderColor: ['transparent', 'transparent'],
        borderWidth: 2
      }]
    },
    options: {
      cutout: '85%',
      responsive: false,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    },
    plugins: [centroTexto]
  });
}

fetch('/api/v1/inventario_por_categoria')
  .then(res => res.json())
  .then(data => {
    new Chart(document.getElementById('tortaChart'), {
      type: 'pie',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Inventario por categor√≠a',
          data: data.valores,
          backgroundColor: [
            '#1b2e44', '#2d3f58', '#3f5874', '#547AA5', '#7896BA', '#9FB9D4'
          ],
          borderColor: 'transparent',
          borderWidth: 2
        }]
      },
      options: {
        radius: '90%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#ffffff',
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  });

fetch('/api/v1/ventas_mensuales')
  .then(res => res.json())
  .then(data => {
    new Chart(document.getElementById('lineChart'), {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Ventas mensuales',
          data: data.valores,
          borderColor: '#579ae1ff',
          backgroundColor: '#162536ff',
          fill: false,
          tension: 0.3
        }]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: '#ffffff',
              font: {
                family: 'sans-serif',
                size: 14
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#ffffff',
            },
            grid: {
              color: '#162536ff'
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              color: '#ffffff',
              callback: value => '$' + value
            },
            grid: {
              color: '#162536ff'
            }
          }
        }
      }
    });
  });

fetch('/api/v1/ventas_periodo')
  .then(res => res.json())
  .then(data => {
    crearDoughnut('grafDia', data.dia, 'D√≠a');
    crearDoughnut('grafSemana', data.semana, 'Semana');
    crearDoughnut('grafMes', data.mes, 'Mes');
  })
  .catch(error => console.error('Error al cargar ventas por periodo:', error));
</script>



</body>
</html>