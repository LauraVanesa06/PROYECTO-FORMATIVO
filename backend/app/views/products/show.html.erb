<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for(:title) || "Appsena" %></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <%= csrf_meta_tags %>
      <%= csp_meta_tag %>
      <%= yield :head %>
      <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
      <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

      <link rel="icon" href="/icon.png" type="image/png">
      <link rel="apple-touch-icon" href="/icon.png">

      <%# Includes all stylesheet files in app/assets/stylesheets %>
      <%= stylesheet_link_tag :abootstrap, "data-turbo-track": "reload" %>
      <%= stylesheet_link_tag :application, "data-turbo-track": "reload" %>
      <%= stylesheet_link_tag "product", media: "all" %>
      <%= javascript_importmap_tags %>

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    
    <section class="view-product">
      <section class="container-product">
        <section class="set-img">
          <article>
            <div class="first-img">
              <div class="carousel">
                <% if @product.images.attached? %>
                  <% @product.images.each_with_index do |img, i| %>
                    <div class="carousel-item <%= 'active' if i == 0 %>">
                      <%= image_tag img, alt: @product.nombre %>
                    </div>
                  <% end %>
                <% else %>
                  <div class="carousel-item active">
                    <%= image_tag "ProductoNoDisponible.png", alt: "Sin imagen" %>
                  </div>
                <% end %>

                <button class="prev" onclick="moveSlide(-1)">&#10094;</button>
                <button class="next" onclick="moveSlide(1)">&#10095;</button>
              </div>
              <script>
                let currentIndex = 0;
                function moveSlide(step) {
                  const items = document.querySelectorAll(".carousel-item");
                  items[currentIndex].classList.remove("active");
                  currentIndex = (currentIndex + step + items.length) % items.length;
                  items[currentIndex].classList.add("active");
                }
              </script>
            </div>
          </article>
        </section>
        <section class="set-info">
          <div class="div-info">
            <div class="d1"><p><%= @product.nombre %></p>
            </div>
            <div class="d2"><p><%= @product.category.nombre %></p>
            </div>
            <div class="d3"><p><%= @product.descripcion %></p>
            </div>
            <div class="cont-stock">
              <div class="cont-img2">
              </div>
              <div class="stock">
                <div class="d4"><p>Compras</p></div>
                <div class="d5"><p>100 Usuarios</p></div>
              </div>
              <div class="cont-img"></div>
              <div class="stock">
                <div class="d4"><p>Stock</p></div>
                <div class="d5"><p><%= @product.stock %> Unidades</p></div>
              </div>
            </div>

            <article class="carousel-container">
              <button class="carousel-btn prev" onclick="moveCarousel(-1)">&#10094;</button>
              <div class="carousel-track" id="carousel-track">
                <% @product.images.drop(0).each do |img| %>
                  <div class="all-img">
                    <%= image_tag img, alt: @product.nombre %>
                  </div>
                <% end %>
              </div>

              <button class="carousel-btn next" onclick="moveCarousel(1)">&#10095;</button>

            </article>

            <!--Carrusel para mover las imagenes de all-img-->
            <script>
              document.addEventListener("DOMContentLoaded", () => {
                const track = document.querySelector(".carousel-track");
                const prevBtn = document.querySelector(".carousel-btn.prev");
                const nextBtn = document.querySelector(".carousel-btn.next");
                const imgWidth = document.querySelector(".all-img").offsetWidth + 10; // ancho + margen
                let index = 0;

                nextBtn.addEventListener("click", () => {
                  const maxIndex = track.children.length - Math.floor(document.querySelector(".carousel-container").offsetWidth / imgWidth);
                  if (index < maxIndex) {
                    index++;
                    track.style.transform = `translateX(-${index * imgWidth}px)`;
                  }
                });

                prevBtn.addEventListener("click", () => {
                  if (index > 0) {
                    index--;
                    track.style.transform = `translateX(-${index * imgWidth}px)`;
                  }
                });
              });
            </script>

            <div class="d6"><p>$ <%= @product.precio_cop %> COP</p></div>
            <div class="d7"><p><%= @product.disponible? ? "Disponible" : "No disponible" %></p></div>
            
          </ul>
            <!--estrellas-->
            <div class="rating">
              <input value="5" name="rating" id="star5" type="radio">
              <label for="star5"></label>
              <input value="4" name="rating" id="star4" type="radio">
              <label for="star4"></label>
              <input value="3" name="rating" id="star3" type="radio">
              <label for="star3"></label>
              <input value="2" name="rating" id="star2" type="radio">
              <label for="star2"></label>
              <input value="1" name="rating" id="star1" type="radio">
              <label for="star1"></label>
            </div>

        </section>
        <section class="set-pago">
          <article class="pago">
            <div class="btns">
              <%= button_to cart_items_path(product_id: @product.id),
                method: :post,
                remote: true,
                class: "btn-agg" do %>
                Agregar al carrito
              <% end %>

              <button class="btn-buy">¡Comprar!</button>
              <button id="pay-with-wompi" data-amount="<%= (@product.precio * 1).round(2) %>">
                Pagar con Wompi
              </button>
            
            </div>
            <div class="metodo">
              <p class="p1">Metodos de pago</p>
              <p>Tarjeta de Crédito/Débito</p>
              <div class="credito"></div>
              <p>Pago por Tranferencia</p>
              <div class="transferencia"></div>
            </div>
            <div class="direccion">
              <div>dirección:</div>
              <div>Calle 6A No. 11-32</div>
              <div>Cels.: 310 730 6745 - 300 433 4132</div>
              <div>E-mail: ferrecampeche@hotmail.com</div>
            </div>
          </article>
        </section>
      </section>
    </section>

    <!--Importante: modifica la imagenes de acuerdo a la miniatura seleccionada-->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const thumbs = document.querySelectorAll(".all-img img");
          const mainItems = document.querySelectorAll(".first-img .carousel-item");
          const mainSingleImg = mainItems.length ? null : document.querySelector(".first-img img"); 

          let currentIndex = 0;

          if (mainItems.length) {
            const activeIdx = Array.from(mainItems).findIndex(el => el.classList.contains("active"));
            currentIndex = activeIdx >= 0 ? activeIdx : 0;
          } else if (mainSingleImg) {
            const idx = Array.from(thumbs).findIndex(t => t.src === mainSingleImg.src);
            currentIndex = idx >= 0 ? idx : 0;
          }

          function setActive(i) {
            if (!thumbs.length) return;
            i = (i + thumbs.length) % thumbs.length;
            currentIndex = i;

            if (mainItems.length) {
              mainItems.forEach(el => el.classList.remove("active"));
              if (mainItems[i]) mainItems[i].classList.add("active");
            } else if (mainSingleImg) {
              mainSingleImg.src = thumbs[i].src;
            }
          }

          thumbs.forEach((thumb, i) => {
            thumb.addEventListener("click", () => setActive(i));
          });

          window.moveSlide = function(step) {
            setActive(currentIndex + step);
          };
        });
      </script>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      
          // Escuchar clics SOLO en botones .btn-agg
          document.querySelectorAll(".btn-agg").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.preventDefault();
              const form = btn.closest("form");
              try {
                const response = await fetch(form.action, {
                  method: "POST",
                  headers: {
                    "X-CSRF-Token": csrfToken,
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({})
                });

                if (response.ok) {
                  const data = await response.json();

                  // Notificación tipo toast
                  showNotification("✅ Producto agregado al carrito");

                  // Actualizar contador del carrito
                  const cartCount = document.getElementById("cart_count");
                  if (cartCount && data.count !== undefined) {
                    cartCount.textContent = data.count;
                  }
                } else {
                  showNotification("⚠️ No se pudo agregar el producto");
                }
              } catch (error) {
                console.error("Error al agregar al carrito:", error);
                showNotification("❌ Error al agregar producto");
              }
            });
          });

          // Mostrar notificación
          function showNotification(message) {
            const notification = document.createElement("div");
            notification.textContent = message;
            notification.style.position = "fixed";
            notification.style.bottom = "20px";
            notification.style.right = "20px";
            notification.style.background = "#198754";
            notification.style.color = "#fff";
            notification.style.padding = "12px 18px";
            notification.style.borderRadius = "10px";
            notification.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
            notification.style.fontWeight = "600";
            notification.style.zIndex = "2000";
            notification.style.opacity = "0";
            notification.style.transition = "opacity 0.3s ease";

            document.body.appendChild(notification);
            setTimeout(() => (notification.style.opacity = "1"), 100);

            setTimeout(() => {
              notification.style.opacity = "0";
              setTimeout(() => notification.remove(), 500);
            }, 2500);
          }
        });

      </script>
      <script>
        document.getElementById('pay-with-wompi')?.addEventListener('click', async function() {
          const amount = parseFloat(this.dataset.amount);
          const resp = await fetch('/payments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ amount: amount, currency: 'COP', redirect_url: window.location.href })
          });
          const data = await resp.json();
          if (data.checkout_url) {
            window.location = data.checkout_url;
          } else if (data.error) {
            alert('Error iniciando pago: ' + data.error);
          } else {
            console.log(data);
            alert('Respuesta desconocida al crear pago');
          }
        });
      </script>
  </body>
</html>