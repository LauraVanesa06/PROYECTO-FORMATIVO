<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%= stylesheet_link_tag "modals", media: "all" %>
</head>
<body>
  <div class="contact-container">
    <%= form_with(model: product, local: true, html: { multipart: true}, class: 'form-form') do |form| %>
      <% if product.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(product.errors.count, "error") %> prohibited this product from being saved:</h2>

          <ul>
            <% product.errors.each do |error| %>
              <li><%= error.full_message %></li> 
            <% end %>
          </ul>
        </div>
      <% end %>
      <section class="form">

        <label for="file-input" class="drop-container">
          <span class="form-title">Agregar imagen</span>
          <span class="drop-title">Arrastra y suelta aquí<br>o</span>
          <%= form.file_field :images, multiple: true, accept: "image/*", direct_upload: true %>
        </label>
        <% if product.persisted? && product.images.attached? %>
          <div style="margin-top:1rem;">
            <p><strong>Imágenes actuales (marca para eliminar):</strong></p>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
              <% product.images.each do |img| %>
                <div style="border:1px solid #ddd; padding:8px; border-radius:8px; text-align:center;">
                  <%= image_tag img.variant(resize_to_limit: [160, 160]).processed, style: "display:block; margin:0 auto 6px;" %>
                  <label style="display:block;">
                    <input type="checkbox" name="product[remove_image_ids][]" value="<%= img.id %>">
                    Quitar
                  </label>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <script>
          document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('preview');

            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
              }
              reader.readAsDataURL(file);
            } else {
              preview.src = "";
              preview.style.display = 'none';
            }
          });
        </script>
      </section>

      <section class="form-edit-new">
        <div class= "end">
          <div class="input-box">
            <label>Nombre</label>
            <%= form.text_field :nombre, id: 'edit-nombre' %>
          </div>
          <div class="column">
            <div class="input-box">
              <label>Precio</label>
              <%= form.text_field :precio, id: 'edit-precio' %>
            </div>
            <div class="input-box">
              <label>Stock</label>
              <%= form.number_field :stock, id: 'edit-stock' %>
            </div>
          </div>
          <div class="input-box">
            <label>Descripción</label>
            <%= form.text_area :descripcion, id: 'edit-descripcion', class: 'descripcion' %>
          </div>
          <div class="input-box address">
            <div class="input-box">
              <label>Categoria</label>
              <%= form.collection_select :category_id, Category.all, :id, :nombre, { prompt: "Seleccione una categoría" }, id: 'edit-categoria', class:'select-box' %>
            </div>
            <div class="input-box">
              <label>Proveedor</label>
              <%= form.collection_select :supplier_id, Supplier.all, :id, :nombre, { prompt: "Seleccione un proveedor" }, id: 'edit-proveedor', class:'select-box' %>
            </div>
          </div>
          <div class="row">
            <%# link_to "Eliminar", product_path(product), method: :delete, data: { confirm: "¿Estás segura que quieres eliminar este producto?" }, class: "eliminar" %>
            <%= form.submit "Guardar", class: 'guardar' %>
          </div>
        </div>
      </section>
    <% end %>
  </div>
</body>
</html>