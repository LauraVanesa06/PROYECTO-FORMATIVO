<!-- PRODUCTOS -->
<section id="all-pro">

  <!-- FILTRO -->
  <div class="filtro-productos">
    <%= form_with url: productos_path, method: :get, local: true, html: { id: 'productos-filter-form', data: { autosubmit: true } } do %>
      <div class="row align-items-center g-3">  
        <div class="col-md-3">
          <%= label_tag :category_id, t('productos.filtro.categoria') %>
          <%= select_tag :category_id,
                        options_from_collection_for_select(@categories, :id, :nombre, params[:category_id]),
                        include_blank: t('productos.filtro.todas_categorias'),
                        class: "form-select" %>
        </div>

        <div class="col-md-3">
          <%= label_tag :query, t('productos.filtro.buscar_nombre') %>
          <%= text_field_tag :query, params[:query], class: "form-control", placeholder: t('productos.filtro.placeholder_nombre') %>
        </div>

        <div class="col-md-2">
          <%= label_tag :min_price, t('productos.filtro.precio_minimo') %>
          <%= number_field_tag :min_price, params[:min_price], min: 0, step: 0.01, class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= label_tag :max_price, t('productos.filtro.precio_maximo') %>
          <%= number_field_tag :max_price, params[:max_price], min: 0, step: 0.01, class: "form-control" %>
        </div>

        <!-- Eliminado bot√≥n de filtrar: ahora el formulario se env√≠a autom√°ticamente al cambiar campos -->
      </div>
    <% end %>
  </div>

  <div class="section-header">
    <h2 class="titulo"><%= t('productos.titulo') %></h2>
    <center><hr class="linea-bonita"></center>
  </div>

  <% if @productos.any? %>
    <div class="product-grid">
      <% @productos.each do |producto| %>
        <%# Doble verificaci√≥n de disponibilidad %>
        <% if producto.disponible %>
          <div class="product-card" data-producto-id="<%= producto.id %>">

            <!-- Imagen -->
            <div class="product-thumb">
              <% if producto.images.attached? %>
                <%= image_tag(
                    producto.images.first.variant(resize_to_fill: [250, 250], saver: { quality: 75 }),
                    alt: producto.nombre,
                    class: "img-fluid",
                    loading: "lazy"
                  ) %>
              <% else %>
                <%= image_tag "ProductoNoDisponible.png", alt: t('productos.sin_imagen'), class: "img-fluid", loading: "lazy" %>
              <% end %>
            </div>

            <!-- Detalles -->
            <div class="product-body">
              <div class="info-product">
                <h3 class="product-name"><%= producto.nombre %></h3>
                <p class="product-desc"><%= truncate(producto.descripcion, length: 80) %></p>
              </div>

              <div class="product-meta">
                <span class="price"><%= producto.precio_cop %></span>

                <div class="d-flex flex-wrap gap-2 mt-2">

                  <!-- Bot√≥n comprar (fetch + toast, sin redirecci√≥n) -->
                  <button 
                    class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center add-to-cart-btn" 
                    data-url="<%= cart_items_path(product_id: producto.id) %>">
                    <i class="fa-solid fa-cart-plus"></i>
                  </button>

                  <!-- Bot√≥n favoritos -->
                  <% if current_user %>
                    <% favorite = current_user.favorites.find_by(product_id: producto.id) %>
                    <% if favorite %>
                      <button 
                        class="btn btn-sm btn-warning d-flex align-items-center gap-1 favorite-btn"
                        data-url="<%= favorite_path(favorite) %>"
                        data-method="delete"
                        data-product-id="<%= producto.id %>">
                        <i class="fa-solid fa-star"></i>
                      </button>
                    <% else %>
                      <button 
                        class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1 favorite-btn"
                        data-url="<%= favorites_path(product_id: producto.id) %>"
                        data-method="post"
                        data-product-id="<%= producto.id %>">
                        <i class="fa-regular fa-star"></i>
                      </button>
                    <% end %>
                  <% else %>
                    <button class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1" disabled>
                      <i class="fa-regular fa-star"></i>
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-warning text-center mt-4">
      <i class="fa-solid fa-exclamation-triangle me-2"></i>
      No se encontraron productos disponibles con los filtros aplicados.
    </div>
  <% end %>

  <!-- PAGINACI√ìN -->
  <% if @pagy && @pagy.pages > 1 %>
    <nav aria-label="Page navigation" class="d-flex justify-content-center my-4">
      <ul class="pagination" id="pagination-nav">
        <% if @pagy.prev %>
          <li class="page-item">
            <a href="#" class="page-link pagination-link" data-page="<%= @pagy.prev %>">‚Üê Anterior</a>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">‚Üê Anterior</span>
          </li>
        <% end %>

        <% @pagy.series.each do |item| %>
          <% if item.is_a?(Integer) %>
            <% if item == @pagy.page %>
              <li class="page-item active">
                <span class="page-link"><%= item %></span>
              </li>
            <% else %>
              <li class="page-item">
                <a href="#" class="page-link pagination-link" data-page="<%= item %>"><%= item %></a>
              </li>
            <% end %>
          <% elsif item == "gap" %>
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          <% end %>
        <% end %>

        <% if @pagy.next %>
          <li class="page-item">
            <a href="#" class="page-link pagination-link" data-page="<%= @pagy.next %>">Siguiente ‚Üí</a>
          </li>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Siguiente ‚Üí</span>
          </li>
        <% end %>
      </ul>
    </nav>
  <% end %>
</section>

<!-- TOAST container -->
<div id="toast-container" 
     class="toast-container position-fixed bottom-0 end-0 p-3"
     style="z-index: 1055;">
</div>

<script>
  // NUEVO: abre el sidebar de perfil
  function openProfileSidebar() {
    const btn = document.getElementById("userButton");
    if (btn) btn.click();
    else {
      const sidebar = document.getElementById("profileSidebar");
      if (sidebar) sidebar.classList.add("open");
    }
  }

  document.addEventListener("click", async (e) => {
    // CARRITO - debe ser PRIMERO y espec√≠fico
    if (e.target.closest(".add-to-cart-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".add-to-cart-btn");
      const url = btn.dataset.url;

      if (!url) {
        console.error("No URL found for cart button");
        showToast("Error: URL no encontrada", "danger");
        return;
      }

      // Si no hay sesi√≥n, abrir sidebar y detener
      if (!window.isLoggedIn) {
        openProfileSidebar();
        return;
      }

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
            "Accept": "application/json"
          }
        });

        if (response.ok) {
          const data = await response.json();

          // üîπ Actualiza el contenido del carrito (offcanvas)
          if (data.cart_html) {
            const cartBody = document.querySelector("#cart-offcanvas-body");
            if (cartBody) cartBody.innerHTML = data.cart_html;
          }

          // üîπ Actualiza el contador
          const cartCount = document.querySelector("#cart-count");
          if (cartCount && data.count !== undefined) {
            cartCount.textContent = data.count;
          }

          // üîπ Muestra notificaci√≥n
          showToast("Producto agregado al carrito", "success");
        } else {
          console.error("Response not ok:", response.status);
          showToast("Error al agregar al carrito", "danger");
        }
      } catch (error) {
        console.error("Fetch error:", error);
        showToast("Error de conexi√≥n", "danger");
      }
      return;
    }

    // FAVORITOS
    if (e.target.closest(".favorite-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".favorite-btn");
      const url = btn.dataset.url;
      const method = (btn.dataset.method || "post").toUpperCase();
      const productId = btn.dataset.productId;

      // Si no hay sesi√≥n, abrir sidebar y detener
      if (!window.isLoggedIn) {
        openProfileSidebar();
        return;
      }

      const response = await fetch(url, {
        method: method,
        headers: {
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
          "Accept": "application/json"
        }
      });

      if (response.ok) {
        if (method === "POST") {
          const data = await response.json(); // debe traer { id: ... }
          btn.dataset.method = "delete";
          if (data.id) btn.dataset.url = `/favorites/${data.id}`;
          btn.classList.remove("btn-outline-warning");
          btn.classList.add("btn-warning");
          btn.innerHTML = '<i class="fa-solid fa-star"></i>';
          showToast("Producto agregado a favoritos", "warning");
        } else {
          btn.dataset.method = "post";
          btn.dataset.url = `/favorites?product_id=${productId}`;
          btn.classList.remove("btn-warning");
          btn.classList.add("btn-outline-warning");
          btn.innerHTML = '<i class="fa-regular fa-star"></i>';
          showToast("Producto eliminado de favoritos", "danger");
        }
      } else {
        showToast("Error al gestionar favoritos", "danger");
      }
      return;
    }

    // Click en la tarjeta ‚Üí ir a producto_show din√°micamente (excepto botones internos)
    const card = e.target.closest(".product-card");
    if (!card) return;
    if (e.target.closest("button") || e.target.closest("i")) return;
    const productoId = card.dataset.productoId;
    
    // Cargar din√°micamente en lugar de recargar
    loadProductDetails(productoId);
  });

  // Funci√≥n toast reutilizable
  function showToast(message, type) {
    const toast = document.createElement("div");
    let bg = "text-bg-primary";
    if (type === "success") bg = "text-bg-success";
    if (type === "warning") bg = "text-bg-warning";
    if (type === "danger") bg = "text-bg-danger";

    toast.className = `toast align-items-center ${bg} border-0 show mb-2 shadow`;
    toast.setAttribute("role", "alert");
    toast.style.minWidth = "250px";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body text-center w-100">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;

    document.querySelector("#toast-container").appendChild(toast);

    setTimeout(() => {
      toast.classList.remove("show");
      toast.classList.add("fade");
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  }

  // --- Auto-submit del formulario de filtros ---
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  function initAutoFilter() {
    const form = document.getElementById('productos-filter-form');
    if (!form) return;

    const inputs = Array.from(form.querySelectorAll('select, input[type="text"], input[type="number"], input[type="search"]'));

    // submit inmediato en selects y number
    inputs.forEach((el) => {
      if (el.tagName.toLowerCase() === 'select' || el.type === 'number') {
        el.addEventListener('change', () => form.submit());
      } else {
        // debounce para campos de texto
        el.addEventListener('input', debounce(() => form.submit(), 450));
      }
    });
  }

  // Inicializar cuando el DOM est√© listo (incluye Turbo si est√° presente)
  ['DOMContentLoaded', 'turbo:load'].forEach(evt => document.addEventListener(evt, initAutoFilter));
</script>
