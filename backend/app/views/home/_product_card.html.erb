<div class="product-card" data-producto-id="<%= producto.id %>" style="cursor:pointer;">
  
  <!-- Imagen -->
  <div class="product-thumb">
    <% if producto.images.attached? %>
      <%= image_tag(
          url_for(producto.images.first.variant(resize_to_limit: [300, 300])),
          alt: producto.nombre,
          class: "img-fluid",
          loading: "lazy",
          decoding: "async",
          onerror: "this.src='/assets/ProductoNoDisponible.png';"
        ) %>
    <% else %>
      <%= image_tag("martillo-dewalt.png", 
          alt: producto.nombre, 
          class: "img-fluid",
          loading: "lazy",
          decoding: "async"
        ) %>
    <% end %>
  </div>

  <!-- Detalles -->
  <div class="product-body">
    <div class="info-product">
      <h3 class="product-name"><%= producto.nombre %></h3>
      <p class="product-desc"><%= truncate(producto.descripcion, length: 80) %></p>
    </div>

    <div class="product-meta">
      <span class="price"><%= producto.precio_cop %></span>

      <div class="d-flex flex-wrap gap-2 mt-2">
        <!-- Botón comprar -->
        <button 
          class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center add-to-cart-btn" 
          data-url="<%= cart_items_path(product_id: producto.id) %>" 
          type="button"
          style="width: 38px; height: 36px; min-width: 38px; padding: 0;">
          <i class="fa-solid fa-cart-plus"></i>
        </button>


        <!-- Botón favoritos con lógica AJAX -->
        <% if current_user %>
          <% # Usar is_favorite si viene del controlador, si no buscar en la BD %>
          <% favorite = defined?(is_favorite) && is_favorite ? OpenStruct.new(id: favorite_id) : current_user.favorites.find_by(product_id: producto.id) %>
          <% if favorite %>
            <button 
              class="btn btn-sm btn-warning d-flex align-items-center gap-1 favorite-btn"
              data-url="<%= favorite_path(favorite) %>"
              data-method="delete"
              data-product-id="<%= producto.id %>">
              <i class="fa-solid fa-star"></i>
            </button>
          <% else %>
            <button 
              class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1 favorite-btn"
              data-url="<%= favorites_path(product_id: producto.id) %>"
              data-method="post"
              data-product-id="<%= producto.id %>">
              <i class="fa-regular fa-star"></i>
            </button>
          <% end %>
        <% else %>
          <button class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1" disabled>
            <i class="fa-regular fa-star"></i>
          </button>
        <% end %>
      </div>
    </div>
  </div>
</div>
