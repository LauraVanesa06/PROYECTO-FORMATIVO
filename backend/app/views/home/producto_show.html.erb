<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= content_for(:title) || "Appsena" %></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= yield :head %>
    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :abootstrap, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag :application, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "product", media: "all" %>
    <%= javascript_importmap_tags %>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- TOASTS -->
  <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>
    
  <section class="view-product">
    <section class="container-product">
      <section class="set-img">
        <article>
          <div class="first-img">
            <div class="carousel">
              <% if @product.images.attached? %>
                <% @product.images.each_with_index do |img, i| %>
                  <div class="carousel-item <%= 'active' if i == 0 %>">
                      <%= image_tag img, alt: @product.nombre, onerror: "this.onerror=null;this.src='/assets/ProductoNoDisponible.png';" %>
                  </div>
                <% end %>
              <% else %>
                <div class="carousel-item active">
              <%= image_tag "ProductoNoDisponible.png", alt: "Sin imagen", onerror: "this.onerror=null;this.src='/assets/ProductoNoDisponible.png';" %>
                </div>
              <% end %>

              <button class="prev" onclick="moveSlide(-1)">&#10094;</button>
              <button class="next" onclick="moveSlide(1)">&#10095;</button>
            </div>
            <script>
              let currentIndex = 0;
              function moveSlide(step) {
                const items = document.querySelectorAll(".carousel-item");
                items[currentIndex].classList.remove("active");
                currentIndex = (currentIndex + step + items.length) % items.length;
                items[currentIndex].classList.add("active");
              }
            </script>
          </div>
        </article>
      </section>
      <section class="set-info">
        <div class="div-info" style="margin-top: 33px;">
          <div class="d1"><p><%= @product.nombre %></p></div>
          <div class="d2"><p><%= @product.category.nombre %></p></div>
          <div class="d3"><p><%= @product.descripcion %></p></div>
          <div class="cont-stock">
            <div class="cont-img2"></div>
            <div class="stock">
              <div class="d4"><p>Compras</p></div>
              <div class="d5"><p><%= @product.buyers_count || 0 %> Usuarios</p></div>
            </div>
            <div class="cont-img"></div>
            <div class="stock">
              <div class="d4"><p>Stock</p></div>
              <div class="d5"><p><%= @product.stock %> Unidades</p></div>
            </div>
          </div>

          <article class="carousel-container">

            <button class="carousel-btn prev" onclick="moveCarousel(-1)">&#10094;</button>

            <div class="carousel-track" id="carousel-track">
              <% @product.images.drop(0).each do |img| %>
                <div class="all-img">
                    <%= image_tag img, alt: @product.nombre, onerror: "this.onerror=null;this.src='/assets/ProductoNoDisponible.png';" %>
                </div>
              <% end %>
            </div>

            <button class="carousel-btn next" onclick="moveCarousel(1)">&#10095;</button>

          </article>

          <!--Carrusel para mover las imagenes de all-img-->
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              const track = document.querySelector(".carousel-track");
              const prevBtn = document.querySelector(".carousel-btn.prev");
              const nextBtn = document.querySelector(".carousel-btn.next");
              const imgWidth = document.querySelector(".all-img").offsetWidth + 10; // ancho + margen
              let index = 0;

              nextBtn.addEventListener("click", () => {
                const maxIndex = track.children.length - Math.floor(document.querySelector(".carousel-container").offsetWidth / imgWidth);
                if (index < maxIndex) {
                  index++;
                  track.style.transform = `translateX(-${index * imgWidth}px)`;
                }
              });

              prevBtn.addEventListener("click", () => {
                if (index > 0) {
                  index--;
                  track.style.transform = `translateX(-${index * imgWidth}px)`;
                }
              });
            });
          </script>

          <div class="d6"><p>$ <%= @product.precio_cop %> COP</p></div>
          <div class="d7"><p><%= @product.disponible && @product.stock > 0 ? "Disponible" : "No disponible" %></p></div>
        </ul>
        <!--estrellas
          <div class="rating">
            <input value="5" name="rating" id="star5" type="radio">
            <label for="star5"></label>
            <input value="4" name="rating" id="star4" type="radio">
            <label for="star4"></label>
            <input value="3" name="rating" id="star3" type="radio">
            <label for="star3"></label>
            <input value="2" name="rating" id="star2" type="radio">
            <label for="star2"></label>
            <input value="1" name="rating" id="star1" type="radio">
            <label for="star1"></label>
          </div>
        -->

      </section>
      <section class="set-pago">
        <article class="pago">
          <div class="btns">
            <%= button_to cart_items_path(product_id: @product.id),
              method: :post,
              remote: true,
              class: "btn-agg add-to-cart-btn",
              data: { url: cart_items_path(product_id: @product.id) } do %>
              Agregar al carrito
            <% end %>

            <!-- Reemplazar el botón estático con Wompi -->
            <div id="wompi-single-product" class="btn-buy">
              <script
                src="https://checkout.wompi.co/widget.js"
                data-render="button"
                data-public-key="pub_test_f0bOPKD5aHr1J6hgSEc9KhPLAFFrOk66"
                data-currency="COP"
                data-amount-in-cents="<%= (@product.precio * 100).to_i %>"
                data-reference="product_<%= @product.id %>_<%= Time.current.to_i %>"
                data-signature-integrity=""
              ></script>
            </div>
          </div>
          <div class="metodo">
            <p class="p1">Metodos de pago</p>
            <p>Tarjeta de Crédito/Débito</p>
            <div class="credito"></div>
            <p>Pago por Tranferencia</p>
            <div class="transferencia"></div>
          </div>
          <div class="direccion">
            <div>dirección:</div>
            <div>Calle 6A No. 11-32</div>
            <div>Cels.: 310 730 6745 - 300 433 4132</div>
            <div>E-mail: ferrecampeche@hotmail.com</div>
          </div>
        </article>
      </section>
    </section>
  </section>

<section class="pro-relacionados">
  <h3 class="titulo">Productos relacionados</h3>
  <center><hr class="linea-bonita"></center>
  <div class="product-grid">
    <% @relacionados.each do |producto| %>
      <div class="product-card" data-producto-id="<%= producto.id %>" style="cursor:pointer;">

        <!-- Imagen -->
        <div class="product-thumb">
          <%= image_tag(
              producto.images.attached? ? url_for(producto.images.first) : "martillo-dewalt.png",
              alt: producto.nombre,
              class: "img-fluid"
            ) %>
        </div>

        <!-- Detalles -->
        <div class="product-body">
          <div class="info-product">
            <h3 class="product-name"><%= producto.nombre %></h3>
            <p class="product-desc"><%= truncate(producto.descripcion, length: 80) %></p>
          </div>

          <div class="product-meta">
            <span class="price"><%= producto.precio_cop %></span>

            <div class="d-flex flex-wrap gap-2 mt-2">
              <!-- Botón comprar -->
              <button 
                class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center add-to-cart-btn" 
                data-url="<%= cart_items_path(product_id: producto.id) %>">
                <i class="fa-solid fa-cart-plus"></i>
              </button>

              <!-- Botón favoritos con lógica AJAX -->
              <% if current_user %>
                <% favorite = current_user.favorites.find_by(product_id: producto.id) %>
                <% if favorite %>
                  <button 
                    id="favorite-btn"
                    class="btn btn-sm btn-warning d-flex align-items-center gap-1 favorite-btn"
                    data-url="<%= favorite_path(favorite) %>"
                    data-method="delete"
                    data-product-id="<%= producto.id %>">
                    <i class="fa-solid fa-star"></i>
                  </button>
                <% else %>
                  <button 
                    id="favorite-btn"
                    class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1 favorite-btn"
                    data-url="<%= favorites_path(product_id: producto.id) %>"
                    data-method="post"
                    data-product-id="<%= producto.id %>">
                    <i class="fa-regular fa-star"></i>
                  </button>
                <% end %>
              <% else %>
                <button id="favorite-btn" class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1" disabled>
                  <i class="fa-regular fa-star"></i>
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <% if @relacionados.empty? %>
      <p>No hay productos relacionados.</p>
    <% end %>
  </div>
</section>

<!--Importante: modifica la imagenes de acuerdo a la miniatura seleccionada-->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const thumbs = document.querySelectorAll(".all-img img");
      const mainItems = document.querySelectorAll(".first-img .carousel-item");
      const mainSingleImg = mainItems.length ? null : document.querySelector(".first-img img"); 

      let currentIndex = 0;

      if (mainItems.length) {
        const activeIdx = Array.from(mainItems).findIndex(el => el.classList.contains("active"));
        currentIndex = activeIdx >= 0 ? activeIdx : 0;
      } else if (mainSingleImg) {
        const idx = Array.from(thumbs).findIndex(t => t.src === mainSingleImg.src);
        currentIndex = idx >= 0 ? idx : 0;
      }

      function setActive(i) {
        if (!thumbs.length) return;
        i = (i + thumbs.length) % thumbs.length;
        currentIndex = i;

        if (mainItems.length) {
          mainItems.forEach(el => el.classList.remove("active"));
          if (mainItems[i]) mainItems[i].classList.add("active");
        } else if (mainSingleImg) {
          mainSingleImg.src = thumbs[i].src;
        }
      }

      thumbs.forEach((thumb, i) => {
        thumb.addEventListener("click", () => setActive(i));
      });

      window.moveSlide = function(step) {
        setActive(currentIndex + step);
      };
    });
</script>

<script>
  // Función toast reutilizable
  function showToast(message, type) {
    const toast = document.createElement("div");
    let bg = "text-bg-primary";
    if (type === "success") bg = "text-bg-success";
    if (type === "warning") bg = "text-bg-warning";
    if (type === "danger") bg = "text-bg-danger";

    toast.className = `toast align-items-center ${bg} border-0 show mb-2 shadow`;
    toast.setAttribute("role", "alert");
    toast.style.minWidth = "250px";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body text-center w-100">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;

    document.querySelector("#toast-container").appendChild(toast);

    setTimeout(() => {
      toast.classList.remove("show");
      toast.classList.add("fade");
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  }

  document.addEventListener("click", async (e) => {
    // CARRITO
    if (e.target.closest(".add-to-cart-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".add-to-cart-btn");
      const url = btn.dataset.url;

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
            "Accept": "application/json"
          }
        });

        if (response.ok) {
          const data = await response.json();

          // 🔹 Actualiza el contenido del carrito (offcanvas)
          if (data.cart_html) {
            const cartBody = document.querySelector("#cart-offcanvas-body");
            if (cartBody) cartBody.innerHTML = data.cart_html;
          }

          // 🔹 Actualiza el contador
          const cartCount = document.querySelector("#cart-count");
          if (cartCount && data.count !== undefined) {
            cartCount.textContent = data.count;
          }

          // 🔹 Muestra notificación
          showToast("Producto agregado al carrito", "success");

        } else {
          showToast("Error al agregar al carrito", "danger");
        }
      } catch (error) {
        console.error("Error:", error);
        showToast("Error de conexión", "danger");
      }
      return;
    }

    // FAVORITOS
    if (e.target.closest(".favorite-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".favorite-btn");
      const url = btn.dataset.url;
      const method = btn.dataset.method;

      const response = await fetch(url, {
        method: method.toUpperCase(),
        headers: {
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
          "Accept": "application/json"
        }
      });

      if (response.ok) {
        if (method === "post") {
          const data = await response.json();
          btn.dataset.method = "delete";
          btn.dataset.url = `/favorites/${data.id}`;
          btn.classList.remove("btn-outline-warning");
          btn.classList.add("btn-warning");
          btn.innerHTML = '<i class="fa-solid fa-star"></i>';
          showToast("Producto agregado a favoritos", "warning");
        } else {
          btn.dataset.method = "post";
          btn.classList.remove("btn-warning");
          btn.classList.add("btn-outline-warning");
          btn.innerHTML = '<i class="fa-regular fa-star"></i>';
          showToast("Producto eliminado de favoritos", "danger");
        }
      } else {
        showToast("Error al gestionar favoritos", "danger");
      }
      return;
    }
  });

   // Click en la tarjeta → ir a producto_show.html.erb (excepto botones internos)
  document.addEventListener("click", (e) => {
    const card = e.target.closest(".product-card");
    if (!card) return;
    if (e.target.closest("button") || e.target.closest("i")) return;
    // Redirigir a la ruta personalizada de producto_show
    const productoId = card.dataset.productoId;
    window.location = `/home/producto_show?id=${productoId}`;
  });

</script>


</body>
</html>