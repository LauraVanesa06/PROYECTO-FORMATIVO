<!-- HERO -->
<section class="hero-header">
  <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel" data-bs-interval="7000" style="height: 100%">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <%= image_tag "promo1.png", class: "d-block w-100 carousel-img" %>
      </div>
      <div class="carousel-item">
        <%= image_tag "promo2.jpg", class: "d-block w-100 carousel-img" %>
      </div>
      <div class="carousel-item">
        <%= image_tag "promo3.jpg", class: "d-block w-100 carousel-img" %>
      </div>
    </div>
  </div>

  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden"><%= t("hero.prev") %></span>
  </button>

  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden"><%= t("hero.next") %></span>
  </button>
</section>

<!-- CATEGORÍAS -->
<section class="categories-section mt-4">
  <div class="section-header">
    <h2 class="titulo"><%= t("categories.title") %></h2>
    <center><hr class="linea-bonita"></center>
  </div>
  
  <div class="category-carousel-wrapper position-relative">
    <button class="category-arrow left" aria-label="Anterior" type="button">&#10094;</button>
    <div class="category-carousel" id="category-carousel" role="list">
      <% @categories.each do |c| %>
        <div class="category-card" role="listitem">
          <%= link_to productos_path(category_id: c.id), class: "category-link d-flex flex-column align-items-center" do %>
            <% if c.imagen.attached? %>
              <%= image_tag c.imagen.variant(resize_to_limit: [80, 80]), class: "mb-2 rounded-circle" %>
            <% else %>
              <i class="fa-solid fa-tag fa-2x mb-2"></i>
            <% end %>
            <span><%= c.nombre %></span>
          <% end %>
        </div>
      <% end %>
    </div>
    <button class="category-arrow right" aria-label="Siguiente" type="button">&#10095;</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const carousel = document.getElementById("category-carousel");
      const leftBtn = document.querySelector(".category-arrow.left");
      const rightBtn = document.querySelector(".category-arrow.right");
      const card = carousel.querySelector(".category-card");
      if (!card) return;
      const cardWidth = card.offsetWidth + 16; // 16px gap
      let scrollAmount = cardWidth * 2; // scroll 2 cards per click

      leftBtn.addEventListener("click", () => {
        carousel.scrollBy({ left: -scrollAmount, behavior: "smooth" });
      });
      rightBtn.addEventListener("click", () => {
        carousel.scrollBy({ left: scrollAmount, behavior: "smooth" });
      });
    });
  </script>
</section>

<!-- PRODUCTOS -->
<section id="productos" class="productos-destacados mt-4 mb-5">
  <div class="section-header">
    <h2 class="titulo"><%= t("products.title") %></h2>
    <center><hr class="linea-bonita"></center>
  </div>
  <div class="product-grid">
    <% @productos.each do |producto| %>
      <div class="product-card" data-producto-id="<%= producto.id %>" style="cursor:pointer;">
        
        <!-- Imagen -->
        <div class="product-thumb">
          <%= image_tag(
              producto.images.attached? ? url_for(producto.images.first) : "martillo-dewalt.png",
              alt: producto.nombre,
              class: "img-fluid",
              onerror: "this.onerror=null;this.src='/assets/ProductoNoDisponible.png';"
            ) %>
        </div>

        <!-- Detalles -->
        <div class="product-body">
          <div class="info-product">
            <h3 class="product-name"><%= producto.nombre %></h3>
            <p class="product-desc"><%= truncate(producto.descripcion, length: 80) %></p>
          </div>

          <div class="product-meta">
            <span class="price"><%= producto.precio_cop %></span>

            <div class="d-flex flex-wrap gap-2 mt-2">
              <!-- Botón comprar -->
              <button 
                class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center add-to-cart-btn" 
                data-url="<%= cart_items_path(product_id: producto.id) %>">
                <i class="fa-solid fa-cart-plus"></i>
              </button>

              <!-- Botón favoritos con lógica AJAX -->
              <% if current_user %>
                <% favorite = current_user.favorites.find_by(product_id: producto.id) %>
                <% if favorite %>
                  <button 
                    id="favorite-btn"
                    class="btn btn-sm btn-warning d-flex align-items-center gap-1 favorite-btn"
                    data-url="<%= favorite_path(favorite) %>"
                    data-method="delete"
                    data-product-id="<%= producto.id %>">
                    <i class="fa-solid fa-star"></i>
                  </button>
                <% else %>
                  <button 
                    id="favorite-btn"
                    class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1 favorite-btn"
                    data-url="<%= favorites_path(product_id: producto.id) %>"
                    data-method="post"
                    data-product-id="<%= producto.id %>">
                    <i class="fa-regular fa-star"></i>
                  </button>
                <% end %>
              <% else %>
                <button id="favorite-btn" class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1" disabled>
                  <i class="fa-regular fa-star"></i>
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</section>

<!-- TOASTS -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>

<script>
  document.addEventListener("click", async (e) => {
    // CARRITO
    if (e.target.closest(".add-to-cart-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".add-to-cart-btn");
      const url = btn.dataset.url;

      const response = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
          "Accept": "application/json"
        }
      });

      if (response.ok) {
        const data = await response.json();

        // 🔹 Actualiza el contenido del carrito (offcanvas)
        if (data.cart_html) {
          const cartBody = document.querySelector("#cart-offcanvas-body");
          if (cartBody) cartBody.innerHTML = data.cart_html;
        }

        // 🔹 Actualiza el contador
        const cartCount = document.querySelector("#cart-count");
        if (cartCount && data.count !== undefined) {
          cartCount.textContent = data.count;
        }

        // 🔹 Muestra notificación
        showToast("Producto agregado al carrito", "success");


      } else {
        showToast("Error al agregar al carrito", "danger");
      }
      return;
    }

    // FAVORITOS
    if (e.target.closest(".favorite-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".favorite-btn");
      const url = btn.dataset.url;
      const method = btn.dataset.method;

      const response = await fetch(url, {
        method: method.toUpperCase(),
        headers: {
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
          "Accept": "application/json"
        }
      });

      if (response.ok) {
        if (method === "post") {
          const data = await response.json();
          btn.dataset.method = "delete";
          btn.dataset.url = `/favorites/${data.id}`;
          btn.classList.remove("btn-outline-warning");
          btn.classList.add("btn-warning");
          btn.innerHTML = '<i class="fa-solid fa-star"></i>';
          showToast("Producto agregado a favoritos", "warning");
        } else {
          btn.dataset.method = "post";
          btn.classList.remove("btn-warning");
          btn.classList.add("btn-outline-warning");
          btn.innerHTML = '<i class="fa-regular fa-star"></i>';
          showToast("Producto eliminado de favoritos", "danger");
        }
      } else {
        showToast("Error al gestionar favoritos", "danger");
      }
      return;
    }
  });

  // Función toast reutilizable
  function showToast(message, type) {
    const toast = document.createElement("div");
    let bg = "text-bg-primary";
    if (type === "success") bg = "text-bg-success";
    if (type === "warning") bg = "text-bg-warning";
    if (type === "danger") bg = "text-bg-danger";

    toast.className = `toast align-items-center ${bg} border-0 show mb-2 shadow`;
    toast.setAttribute("role", "alert");
    toast.style.minWidth = "250px";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body text-center w-100">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;

    document.querySelector("#toast-container").appendChild(toast);

    setTimeout(() => {
      toast.classList.remove("show");
      toast.classList.add("fade");
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  }

  // Click en la tarjeta → ir a producto_show.html.erb (excepto botones internos)
  document.addEventListener("click", (e) => {
    const card = e.target.closest(".product-card");
    if (!card) return;
    if (e.target.closest("button") || e.target.closest("i")) return;
    // Redirigir a la ruta personalizada de producto_show
    const productoId = card.dataset.productoId;
    window.location = `/home/producto_show?id=${productoId}`;
  });
</script>
