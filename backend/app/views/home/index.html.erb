<!-- HERO -->
<section class="hero-header">
  <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel" data-bs-interval="7000" style="height: 100%">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <%= image_tag "promo1.png", class: "d-block w-100 carousel-img" %>
      </div>
      <div class="carousel-item">
        <%= image_tag "promo2.jpg", class: "d-block w-100 carousel-img" %>
      </div>
      <div class="carousel-item">
        <%= image_tag "promo3.jpg", class: "d-block w-100 carousel-img" %>
      </div>
    </div>
  </div>

  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden"><%= t("hero.prev") %></span>
  </button>

  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden"><%= t("hero.next") %></span>
  </button>
</section>

<!-- CATEGORÍAS -->
<section class="categories-section mt-4">
  <div class="section-header">
    <h2 class="titulo"><%= t("categories.title") %></h2>
    <center><hr class="linea-bonita"></center>
  </div>
  
  <div class="category-carousel-wrapper position-relative">
    <button class="category-arrow left" aria-label="Anterior" type="button">&#10094;</button>
    <div class="category-carousel" id="category-carousel" role="list">
      <% @categories.each do |c| %>
        <div class="category-card" role="listitem">
          <%= link_to productos_path(category_id: c.id), class: "category-link d-flex flex-column align-items-center" do %>
            <% if c.imagen&.attached? %>
              <%= image_tag c.imagen.variant(resize_to_fill: [80, 80], saver: { quality: 70 }), class: "mb-2 rounded-circle", loading: "lazy" %>
            <% else %>
              <i class="fa-solid fa-tag fa-2x mb-2"></i>
            <% end %>
            <span><%= c.nombre %></span>
          <% end %>
        </div>
      <% end %>
    </div>
    <button class="category-arrow right" aria-label="Siguiente" type="button">&#10095;</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const carousel = document.getElementById("category-carousel");
      const leftBtn = document.querySelector(".category-arrow.left");
      const rightBtn = document.querySelector(".category-arrow.right");
      const card = carousel.querySelector(".category-card");
      if (!card) return;
      const cardWidth = card.offsetWidth + 16; // 16px gap
      let scrollAmount = cardWidth * 2; // scroll 2 cards per click

      leftBtn.addEventListener("click", () => {
        carousel.scrollBy({ left: -scrollAmount, behavior: "smooth" });
      });
      rightBtn.addEventListener("click", () => {
        carousel.scrollBy({ left: scrollAmount, behavior: "smooth" });
      });
    });
  </script>
</section>

<!-- PRODUCTOS -->
<section id="productos" class="productos-destacados mt-4 mb-5">
  <div class="section-header">
    <h2 class="titulo"><%= t("products.title") %></h2>
    <center><hr class="linea-bonita"></center>
  </div>
  
  <% if @productos.any? %>
    <div class="product-grid">
      <% @productos.each do |producto| %>
        <%# Solo mostrar si está disponible %>
        <% if producto.disponible %>
          <%= render 'product_card', producto: producto %>
        <% end %>
      <% end %>
    </div>

    <!-- PAGINACIÓN CON PAGY (ULTRALIGERA Y RÁPIDA) -->
    <% if @pagy.pages > 1 %>
      <nav aria-label="Navegación de páginas" class="mt-5 mb-5">
        <ul class="pagination justify-content-center">
          <% if @pagy.prev %>
            <li class="page-item">
              <%= link_to "← Anterior", url_for(page: @pagy.prev), class: "page-link" %>
            </li>
          <% else %>
            <li class="page-item disabled">
              <span class="page-link">← Anterior</span>
            </li>
          <% end %>

          <% @pagy.series.each do |page_item| %>
            <% if page_item == "..." %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% elsif page_item == @pagy.page %>
              <li class="page-item active">
                <span class="page-link"><%= page_item %></span>
              </li>
            <% else %>
              <li class="page-item">
                <%= link_to page_item, url_for(page: page_item), class: "page-link" %>
              </li>
            <% end %>
          <% end %>

          <% if @pagy.next %>
            <li class="page-item">
              <%= link_to "Siguiente →", url_for(page: @pagy.next), class: "page-link" %>
            </li>
          <% else %>
            <li class="page-item disabled">
              <span class="page-link">Siguiente →</span>
            </li>
          <% end %>
        </ul>
      </nav>
    <% end %>
  <% else %>
    <div class="alert alert-info text-center mt-4">
      <i class="fa-solid fa-info-circle me-2"></i>
      No hay productos disponibles en este momento.
    </div>
  <% end %>
</section>

<!-- TOASTS -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>

<script>
  // Abre el sidebar de perfil como si el usuario presionara el botón del header
  function openProfileSidebar() {
    const btn = document.getElementById("userButton");
    if (btn) btn.click();
    else {
      const sidebar = document.getElementById("profileSidebar");
      if (sidebar) sidebar.classList.add("open");
    }
  }

  document.addEventListener("click", async (e) => {
    // CARRITO
    if (e.target.closest(".add-to-cart-btn")) {
      e.preventDefault();
      e.stopPropagation();
      const btn = e.target.closest(".add-to-cart-btn");
      const url = btn.dataset.url;
      const icon = btn.querySelector("i");

      if (!window.isLoggedIn) {
        openProfileSidebar();
        return;
      }

      // Agregar animación de carga solo al icono
      if (icon) {
        icon.classList.add("icon-loading");
      }
      btn.disabled = true;

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
            "Accept": "application/json"
          }
        });

        const data = await response.json();

        if (response.ok) {
          if (data.cart_html) {
            const cartBody = document.querySelector("#cart-offcanvas-body");
            if (cartBody) cartBody.innerHTML = data.cart_html;
          }
          const cartCount = document.querySelector("#cart-count");
          if (cartCount && data.count !== undefined) {
            cartCount.textContent = data.count;
            if (data.count > 0) {
              cartCount.style.display = 'inline';
            } else {
              cartCount.style.display = 'none';
            }
          }
          showToast("Producto agregado al carrito", "success");
        } else {
          // Error: mostrar mensaje específico del servidor
          const errorMessage = data.error || "Error al agregar al carrito";
          showToast(errorMessage, "danger");
        }
      } catch (error) {
        console.error("Error en la petición:", error);
        showToast("Error de conexión al agregar al carrito", "danger");
      } finally {
        // Remover animación de carga del icono
        if (icon) {
          icon.classList.remove("icon-loading");
        }
        btn.disabled = false;
      }
      return;
    }

    // FAVORITOS
    if (e.target.closest(".favorite-btn")) {
      e.preventDefault();
      e.stopPropagation();

      const btn = e.target.closest(".favorite-btn");
      const url = btn.dataset.url;
      const method = (btn.dataset.method || "post").toUpperCase();
      const productId = btn.dataset.productId;
      const icon = btn.querySelector("i");

      if (!window.isLoggedIn) {
        openProfileSidebar();
        return;
      }

      // Agregar animación de carga al icono
      if (icon) {
        icon.classList.add("icon-loading");
      }
      btn.disabled = true;

      const response = await fetch(url, {
        method: method,
        headers: {
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
          "Accept": "application/json"
        }
      });

      if (response.ok) {
        const data = await response.json();

        if (method === "POST") {
          // creado -> pasar a delete con /favorites/:id
          if (data.id) btn.dataset.url = `/favorites/${data.id}`;
          btn.dataset.method = "delete";
          btn.classList.remove("btn-outline-warning");
          btn.classList.add("btn-warning");
          if (icon) { icon.classList.remove("fa-regular"); icon.classList.add("fa-solid"); }
          showToast("Producto agregado a favoritos", "success");
        } else {
          // eliminado -> volver a post con /favorites?product_id=...
          btn.dataset.url = `/favorites?product_id=${productId}`;
          btn.dataset.method = "post";
          btn.classList.add("btn-outline-warning");
          btn.classList.remove("btn-warning");
          if (icon) { icon.classList.add("fa-regular"); icon.classList.remove("fa-solid"); }
          showToast("Producto eliminado de favoritos", "success");
        }
      } else {
        showToast("Error al actualizar favorito", "danger");
      }
      // Remover animación de carga
      if (icon) {
        icon.classList.remove("icon-loading");
      }
      btn.disabled = false;
      return;
    }

    // NAVEGACIÓN A DETALLE (evitar cuando el click proviene de botones/iconos)
    const card = e.target.closest(".product-card");
    if (card) {
      if (e.target.closest("button") || e.target.closest(".favorite-btn") || e.target.closest("i")) return;
      const productId = card.dataset.productoId;
      window.location.href = `/home/producto_show?id=${productId}`;
    }
  });

  function showToast(message, type) {
    const toastContainer = document.getElementById("toast-container");
    const toast = document.createElement("div");
    const toastId = "toast-" + Date.now();
    toast.id = toastId;

    const bg = type === "success" ? "bg-success" : (type === "danger" ? "bg-danger" : `bg-${type}`);

    toast.className = `toast fade show ${bg} text-white`;
    toast.role = "alert";
    toast.ariaLive = "assertive";
    toast.ariaAtomic = "true";
    toast.style = "z-index: 1055;";
    toast.innerHTML = `
      <div class="toast-header ${bg} text-white">
        <strong class="me-auto">${type === "success" ? "Éxito" : "Aviso"}</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    `;
    toastContainer.appendChild(toast);

    setTimeout(() => {
      const toastElement = document.getElementById(toastId);
      if (toastElement && window.bootstrap?.Toast) {
        const bsToast = new bootstrap.Toast(toastElement);
        bsToast.hide();
        toastElement.addEventListener("hidden.bs.toast", () => toastElement.remove());
      } else if (toastElement) {
        toastElement.classList.remove("show");
        setTimeout(() => toastElement.remove(), 500);
      }
    }, 3000);
  }

  // Click en tarjeta de producto → ir al detalle (evitar si el click fue en botones/iconos)
  document.querySelectorAll(".product-card").forEach(card => {
    card.addEventListener("click", (e) => {
      if (e.target.closest("button") || e.target.closest("i")) return;
      const productId = card.dataset.productoId;
      window.location.href = `/home/producto_show?id=${productId}`;
    });
  });
</script>
